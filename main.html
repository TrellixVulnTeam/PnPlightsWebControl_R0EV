<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>PInPaper-LightControl</title>
</head>

<body>
<H1>Pi 'n Paper - Light Control</H1>
<H2>Spieler:</H2>
<p id="players">
    <div id="p1">
        <p id="p1_name">
            Name Spieler 1:
            <input type="text" width="200" name="name_p1" id="name_p1" onchange="PlayerNameChanged(name_p1)"/>            
        </p>
        <canvas id="Player1" width="100" height="50" onclick="PlayerOnClick('Player1')" onmouseenter="PlayerOnHover('Player1')" onmouseleave="PlayerOnNoHover('Player1')">
            Der verwendete Browser unterstützt nicht alle Funktionen. Bitte verwenden Sie einen modernen Browser.
        </canvas>        
    </div>
    <div id="p2">
        <p id="p2_name">
            Name Spieler 2:
            <input type="text" width="200" name="name_p2" id="name_p2" onchange="PlayerNameChanged(name_p2)"/>            
        </p>
        <canvas id="Player2" width="100" height="50" onclick="PlayerOnClick('Player2')" onmouseenter="PlayerOnHover('Player2')" onmouseleave="PlayerOnNoHover('Player2')">
            Der verwendete Browser unterstützt nicht alle Funktionen. Bitte verwenden Sie einen modernen Browser.
        </canvas>        
    </div>
    <div id="p3">
        <p id="p3_name">
            Name Spieler 3:
            <input type="text" width="200" name="name_p3" id="name_p3" onchange="PlayerNameChanged(name_p3)"/>            
        </p>
        <canvas id="Player3" width="100" height="50" onclick="PlayerOnClick('Player3')" onmouseenter="PlayerOnHover('Player3')" onmouseleave="PlayerOnNoHover('Player3')">
            Der verwendete Browser unterstützt nicht alle Funktionen. Bitte verwenden Sie einen modernen Browser.
        </canvas>        
    </div>
    <div id="p4">
        <p id="p4_name">
            Name Spieler 4:
            <input type="text" width="200" name="name_p4" id="name_p4" onchange="PlayerNameChanged(name_p4)"/>            
        </p>
        <canvas id="Player4" width="100" height="50" onclick="PlayerOnClick('Player4')" onmouseenter="PlayerOnHover('Player4')" onmouseleave="PlayerOnNoHover('Player4')">
            Der verwendete Browser unterstützt nicht alle Funktionen. Bitte verwenden Sie einen modernen Browser.
        </canvas>        
    </div>
    <div id="p5">
        <p id="p5_name">
            Name Spieler 5:
            <input type="text" width="200" name="name_p5" id="name_p5" onchange="PlayerNameChanged(name_p5)"/>            
        </p>
        <canvas id="Player5" width="100" height="50" onclick="PlayerOnClick('Player5')" onmouseenter="PlayerOnHover('Player5')" onmouseleave="PlayerOnNoHover('Player5')">
            Der verwendete Browser unterstützt nicht alle Funktionen. Bitte verwenden Sie einen modernen Browser.
        </canvas>        
    </div>
    <div id="p6">
        <p id="p6_name">
            Name Spieler 6:
            <input type="text" width="200" name="name_p6" id="name_p6" onchange="PlayerNameChanged(name_p6)"/>            
        </p>
        <canvas id="Player6" width="100" height="50" onclick="PlayerOnClick('Player6')" onmouseenter="PlayerOnHover('Player6')" onmouseleave="PlayerOnNoHover('Player6')">
            Der verwendete Browser unterstützt nicht alle Funktionen. Bitte verwenden Sie einen modernen Browser.
        </canvas>        
    </div>
    <div id="p7">
        <p id="p7_name">
            Name Spieler 7:
            <input type="text" width="200" name="name_p7" id="name_p7" onchange="PlayerNameChanged(name_p7)"/>            
        </p>
        <canvas id="Player7" width="100" height="50" onclick="PlayerOnClick('Player7')" onmouseenter="PlayerOnHover('Player7')" onmouseleave="PlayerOnNoHover('Player7')">
            Der verwendete Browser unterstützt nicht alle Funktionen. Bitte verwenden Sie einen modernen Browser.
        </canvas>        
    </div>
    <div id="p8">
        <p id="p8_name">
            Name Spieler 8:
            <input type="text" width="200" name="name_p8" id="name_p8" onchange="PlayerNameChanged(name_p8)"/>            
        </p>
        <canvas id="Player8" width="100" height="50" onclick="PlayerOnClick('Player8')" onmouseenter="PlayerOnHover('Player8')" onmouseleave="PlayerOnNoHover('Player8')">
            Der verwendete Browser unterstützt nicht alle Funktionen. Bitte verwenden Sie einen modernen Browser.
        </canvas>        
    </div>
</p>
<script>
    //Javascript code below everything else, as the objects we might use here need to be declared before.

 
    var player_uis = [];
    player_uis.push({field: "Player1", name: "p1_name", textbox: "name_p1"});
    player_uis.push({field: "Player2", name: "p2_name", textbox: "name_p2"});
    player_uis.push({field: "Player3", name: "p3_name", textbox: "name_p3"});
    player_uis.push({field: "Player4", name: "p4_name", textbox: "name_p4"});
    player_uis.push({field: "Player5", name: "p5_name", textbox: "name_p5"});
    player_uis.push({field: "Player6", name: "p6_name", textbox: "name_p6"});
    player_uis.push({field: "Player7", name: "p7_name", textbox: "name_p7"});
    player_uis.push({field: "Player8", name: "p8_name", textbox: "name_p8"});
    

    // Start: Functions
    function PlayerOnHover(id){ //Handles Canvas_mouse_enter
        //alert("Hovered "+ id);
        canvas_paintyellow(id);
    }

    function PlayerOnNoHover(id){ //Handles Canvas_mouse_leave
        //alert("Hovered "+ id);
        canvas_paintgrey(id);
    }

    function canvas_paintyellow(id){
        var canvas = document.getElementById(id);
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = "yellow";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function canvas_paintgrey(id){
        var canvas = document.getElementById(id);
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = "grey";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function PlayerNameChanged(id){        
        var p = document.getElementById(id.id);
        
        // Get the Player of the current Text-Box
        var Player = getPlayerByTextBox(id.id);
        //alert(Player);
        //drawName(Player, p.value);
        savePlayername(Player, p.value);
    }

    function getPlayerByTextBox(boxname){
        // Will get the PlayerID by a given Textbox
        var myreturn = "Not found!";

        for (let i=0; i<player_uis.length; i++)
        {   
            //alert(boxname + " => " + player_uis[i].textbox + " | " + player_uis[i].field); //DEBUG
            if (boxname == player_uis[i].textbox){  //This must be the textbox that corresponds to our canvas  
                myreturn = player_uis[i].field;             
                break;
            }        
        }        
        //alert("! " + myreturn); //DEBUG
        return myreturn;
    }

    function drawName(myid, texttoprint){
        //alert(myid);
        //alert(texttoprint);        
        var canvas = document.getElementById(myid);
        var ctx = canvas.getContext("2d");
        ctx.font = "30px Arial";
        ctx.fillText(texttoprint, 10, 50);
    }

    function PlayerOnClick(id){
        //Iterate all player UI elements
        for (let i=0; i<player_uis.length; i++)
        {           
            if (id == player_uis[i].field){  //This must be the textbox that corresponds to our canvas                
                toggleNameBox(player_uis[i].name);             
            }            
            else {                
                hideNameBox(player_uis[i].name);
            }
        }
    }

    function toggleNameBox(id){
        var p = document.getElementById(id);  
        //alert(id);
        if (p.hidden == true){            
            showNameBox(id);          
        }
        else {
            hideNameBox(id);
        }        
    }

    function showNameBox(id){
        var p = document.getElementById(id);        
        p.hidden=false;
        p.focus(); 
    }

    function hideNameBox(id){        
        var p = document.getElementById(id);        
        p.hidden=true;
    }

    function savePlayername(id, name){
        //Will set the playername on backend-side
        var uri = encodeURI("http://127.0.0.1:8080/engine?job=setplayer&id="+id+"&name="+name);  //Todo: Need to figure out why this does ten requests at once...
        
        fetch(uri)
        .then(response => {
            if (!response.ok) {
            throw new Error('Spielername konnte nicht übernommen werden!'); //This should not happen
            }
        });
    }
    // End: Functions

    //Iterate all player elements
    for (let i=0; i<player_uis.length; i++){           
        canvas_paintgrey(player_uis[i].field); //Initialize all canvas in grey
        hideNameBox(player_uis[i].name); //Initialize all textboxes as hidden
    }

</script>
</body>
</html>