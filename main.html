<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="height=device-height, initial-scale=0.8">
    <title>Pi 'n Paper-LightControl (by derco0n)</title>
    <script src="./jquery.min.js"></script>
    <style>
        body {
            background: black;
            color: white;
            font-family: Arial, Helvetica, sans-serif;
        }

        input {
            background: rgb(46, 46, 46);            
            color: white;            
            font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            font-size: medium;
            
        }
        input:hover {
            background: rgb(114, 0, 0);
        }

        H1 {
            color: rgb(109, 108, 108);
            text-decoration: underline;
            font-size: larger;
        }

        H2 {
            color: rgb(59, 59, 59);
            font-style: italic;   
            font-size: medium;         
        }

        a {
            text-decoration: overline underline;
            color: rgb(59, 59, 59);            
        }    
        a:visited {
            color: rgb(97, 1, 1);
        }
        a:hover {
            color: rgb(221, 0, 0);
        }

        .block {
            display: flex;
            flex-flow: row wrap;
            align-items: center;
        }

        .smalllink {
            font-size: small; 
        }

        .button {
            border: none;
            color: white;
            padding: 16px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            transition-duration: 0.4s;
            cursor: pointer;
        }

        .button1 {
            background-color: rgb(41, 0, 0); 
            color: rgb(204, 0, 0); 
            border: 2px solid #740000;
        }

        .button1:hover {
            background-color: #9c0000;
            border: 2px solid #ff0000;
            color: white;
        }

	input {
		width: 100%
	}
    </style>
</head>

<body>
<H1>Pi 'n Paper - Light Control v0.15 (by <a href="https://github.com/derco0n">derco0n</a>)</H1>

<H2>Spieler:</H2>
<div id="players">
    <div id="p1" class="block">
        <div id="p1_rank">
        1:
        </div>
        <div id="p1_name">
            <input type="text" placeholder="Spielername" name="name_p1" id="name_p1"
            onchange="PlayerNameChanged(name_p1)" onmouseenter="PlayerOnHover('p1')" onmouseleave="PlayerOnNoHover('p1')" />
        </div>
        <div id="p1_points">
            <input type="number" min="0" placeholder="Punkte" name="points_p1" id="points_p1" onchange="PlayerPointsChanged('points_p1')"/>
        </div>
    </div>
    <div id="p2" class="block">
        <div id="p2_rank">
        2:
        </div>
        <div id="p2_name">
            <input type="text" placeholder="Spielername" name="name_p2" id="name_p2"
            onchange="PlayerNameChanged(name_p2)" onmouseenter="PlayerOnHover('p2')" onmouseleave="PlayerOnNoHover('p2')" />
        </div>
        <div id="p2_points">
            <input type="number" min="0" placeholder="Punkte" name="points_p2" id="points_p2" onchange="PlayerPointsChanged('points_p2')"/>
        </div>
    </div>
    <div id="p3" class="block">
        <div id="p3_rank">
        3:
        </div>
        <div id="p3_name">
            <input type="text" placeholder="Spielername" name="name_p3" id="name_p3"
            onchange="PlayerNameChanged(name_p3)" onmouseenter="PlayerOnHover('p3')" onmouseleave="PlayerOnNoHover('p3')" />
        </div>
        <div id="p3_points">
            <input type="number" min="0" placeholder="Punkte" name="points_p3" id="points_p3" onchange="PlayerPointsChanged('points_p3')"/>
        </div>
    </div>
    <div id="p4" class="block">
        <div id="p4_rank">
        4:
        </div>
        <div id="p4_name">
            <input type="text" placeholder="Spielername" name="name_p4" id="name_p4"
            onchange="PlayerNameChanged(name_p4)" onmouseenter="PlayerOnHover('p4')" onmouseleave="PlayerOnNoHover('p4')" />
        </div>
        <div id="p4_points">
            <input type="number" min="0" placeholder="Punkte" name="points_p4" id="points_p4" onchange="PlayerPointsChanged('points_p4')"/>
        </div>
    </div>
    <div id="p5" class="block">
        <div id="p5_rank">
        5:
        </div>
        <div id="p5_name">
            <input type="text" placeholder="Spielername" name="name_p5" id="name_p5"
            onchange="PlayerNameChanged(name_p5)" onmouseenter="PlayerOnHover('p5')" onmouseleave="PlayerOnNoHover('p5')" />
        </div>
        <div id="p5_points">
            <input type="number" min="0" placeholder="Punkte" name="points_p5" id="points_p5" onchange="PlayerPointsChanged('points_p5')"/>
        </div>
    </div>
    <div id="p6" class="block">
        <div id="p6_rank">
        6:
        </div>
        <div id="p6_name">
            <input type="text" placeholder="Spielername" name="name_p6" id="name_p6"
            onchange="PlayerNameChanged(name_p6)" onmouseenter="PlayerOnHover('p6')" onmouseleave="PlayerOnNoHover('p6')" />
        </div>
        <div id="p6_points">
            <input type="number" min="0" placeholder="Punkte" name="points_p6" id="points_p6" onchange="PlayerPointsChanged('points_p6')"/>
        </div>
    </div>
    <div id="p7" class="block">
        <div id="p7_rank">
        7:
        </div>
        <div id="p7_name">
            <input type="text" placeholder="Spielername" name="name_p7" id="name_p7"
            onchange="PlayerNameChanged(name_p7)" onmouseenter="PlayerOnHover('p7')" onmouseleave="PlayerOnNoHover('p7')" />
        </div>
        <div id="p7_points">
            <input type="number" min="0" placeholder="Punkte" name="points_p7" id="points_p7" onchange="PlayerPointsChanged('points_p7')"/>
        </div>
    </div>
    <div id="p8" class="block">
        <div id="p8_rank">
        8:
        </div>
        <div id="p8_name">
            <input type="text" placeholder="Spielername" name="name_p8" id="name_p8"
            onchange="PlayerNameChanged(name_p8)" onmouseenter="PlayerOnHover('p8')" onmouseleave="PlayerOnNoHover('p8')" />
        </div>
        <div id="p8_points">
            <input type="number" min="0" placeholder="Punkte" name="points_p8" id="points_p8" onchange="PlayerPointsChanged('points_p8')"/>
        </div>
    </div>
</div>

<p>
    <div id="controls">
        <div id="buttons" class="block">
            <div id="btns_startstop">
                <button type="button" class="button1" id="btn_startstop" onclick="Handle_btn_click('btn_startstop')">Runden...</button>
            </div>
            <div id="btns_inround">
                <button type="button" class="button1" id="btn_prevplayer" onclick="Handle_btn_click('btn_prevplayer')">Vorh. Spieler</button>
                <button type="button" class="button1" id="btn_noplayer" onclick="Handle_btn_click('btn_noplayer')">Kein Spieler</button>
                <button type="button" class="button1" id="btn_nextplayer" ontouch="" onclick="Handle_btn_click('btn_nextplayer')">N&auml;chs. Spieler</button>
            </div>
        </div>
    </div>
</p>
<p>
    <a class="smalllink" href="https://github.com/derco0n/PnPlightsWebControl">Sourcecode</a>
</p>
<script>
    //Javascript code below everything else, as the objects we might use here need to be declared before. 
    
    switchmode(false);


    var player_uis = [];
    player_uis.push({id: "p1", rank: "p1_rank", name: "p1_name", textbox_name: "name_p1", textbox_points: "points_p1"});
    player_uis.push({id: "p2", rank: "p2_rank", name: "p2_name", textbox_name: "name_p2", textbox_points: "points_p2"});
    player_uis.push({id: "p3", rank: "p3_rank", name: "p3_name", textbox_name: "name_p3", textbox_points: "points_p3"});
    player_uis.push({id: "p4", rank: "p4_rank", name: "p4_name", textbox_name: "name_p4", textbox_points: "points_p4"});
    player_uis.push({id: "p5", rank: "p5_rank", name: "p5_name", textbox_name: "name_p5", textbox_points: "points_p5"});
    player_uis.push({id: "p6", rank: "p6_rank", name: "p6_name", textbox_name: "name_p6", textbox_points: "points_p6"});
    player_uis.push({id: "p7", rank: "p7_rank", name: "p7_name", textbox_name: "name_p7", textbox_points: "points_p7"});
    player_uis.push({id: "p8", rank: "p8_rank", name: "p8_name", textbox_name: "name_p8", textbox_points: "points_p8"});  

    var player_points = [];
    //ID, playernumber, current-points
    player_points.push({id: "p1", pnum: 1, points: 0});
    player_points.push({id: "p2", pnum: 2, points: 0});
    player_points.push({id: "p3", pnum: 3, points: 0});
    player_points.push({id: "p4", pnum: 4, points: 0});
    player_points.push({id: "p5", pnum: 5, points: 0});
    player_points.push({id: "p6", pnum: 6, points: 0});
    player_points.push({id: "p7", pnum: 7, points: 0});
    player_points.push({id: "p8", pnum: 8, points: 0});
    
    setCurrentPlayer(0);
    
    var textbox_org_background=document.getElementById("name_p1").style.background;  //Save the original color of the Textboxes
    var button_org_background=document.getElementById("btn_prevplayer").style.background;  //Save the original color of the Buttons

    //Add additional onTouch-Handlers as the buttons might not be clicked but touched on mobile devices...
    /*
    document.getElementById("btn_startstop").ontouchend=Handle_btn_click('btn_startstop');
    document.getElementById("btn_prevplayer").ontouchend=Handle_btn_click('btn_prevplayer');
    document.getElementById("btn_noplayer").ontouchend=Handle_btn_click('btn_noplayer');
    document.getElementById("btn_nextplayer").ontouchend=Handle_btn_click('btn_nextplayer');
    */

    // Start: Functions
    function setCurrentPlayer(num){
        // Set the current player... the one who's turn is now
        current_playerindex=num; //Save the current playerindex
        if (num >= 0 && num < player_points.length){
            current_playernumber=player_points[current_playerindex].pnum;  //Save the current playernumber
        }
    }

    function switchmode(inround){
        document.getElementById("btns_inround").hidden=!inround;  // Show in round buttons only if we're actually in a round
        //Make sure, that no points can be entered during a round
        document.getElementById("points_p1").disabled=inround;
        document.getElementById("points_p2").disabled=inround;
        document.getElementById("points_p3").disabled=inround;
        document.getElementById("points_p4").disabled=inround;
        document.getElementById("points_p5").disabled=inround;
        document.getElementById("points_p6").disabled=inround;
        document.getElementById("points_p7").disabled=inround;
        document.getElementById("points_p8").disabled=inround;

        //Make sure, that no names can be changed during a round
        document.getElementById("name_p1").disabled=inround;
        document.getElementById("name_p2").disabled=inround;
        document.getElementById("name_p3").disabled=inround;
        document.getElementById("name_p4").disabled=inround;
        document.getElementById("name_p5").disabled=inround;
        document.getElementById("name_p6").disabled=inround;
        document.getElementById("name_p7").disabled=inround;
        document.getElementById("name_p8").disabled=inround;
        

        if (inround){
            document.getElementById("btn_startstop").innerHTML="Rundenstopp";
            document.getElementById("btn_nextplayer").innerHTML="Erster Spieler";
            document.getElementById("btn_prevplayer").hidden=true;
        }        
        else {
            document.getElementById("btn_startstop").innerHTML="Rundenstart";
        }
    }


    function updatePlayerpoints(id, points){
        // Will update the internally saved points of a player
        for (let i=0; i<player_points.length; i++)
        { 
            if (player_points[i].id == id){
                player_points[i].points = points;
                break;
            }
            //alert(player_points[i].id + " => " + player_points[i].points);
        }        
    }

    function calcPlayerRanks(){
        //Will calculate the players ordering based on their points        
        var key_vals = player_points; //Make a copy of player points        
        //alert("Calc ");  
        key_vals.sort(function compare(kv1, kv2) {
            // This comparison function has 3 return cases:
            // - Negative number: kv1 should be placed AFTER kv2
            // - Positive number: kv1 should be placed BEFORE kv2
            // - Zero: they are equal, order based on pnum            
            rank = kv2["points"] - kv1["points"];
            if (rank == 0){
                //Both players have equal points, make a decission based on the players number in ascending order
                rank = kv1["pnum"] - kv2["pnum"];                
            }
            return rank;
        });

        /*
        //DEBUG
        var result="Sorted:\r\n";
        for (let i=0; i<key_vals.length; i++)
        {   
            result = result + key_vals[i].id + ": Points=" + key_vals[i].points + " Pnum="+key_vals[i].pnum+"\r\n" ;
        }
        alert(result);
        */
        return key_vals;
    }

    function PlayerOnHover(id){ 
        //alert("Hovered "+ id);
        //enlightenPlayer(id); //Test
    }

    function PlayerOnNoHover(id){ 
        //alert("Hovered "+ id);
        //darkenPlayer(id);  //Test       
    }


    function Handle_btn_click(id){
        //Will handle ClickEvents from the buttons
        //alert(id); //DEBUG
        if (id=="btn_startstop"){
            // Start/Stop of a round requested...
            if (document.getElementById("btn_startstop").innerHTML=="Rundenstart"){
                
                //Update points values...
                getAllPoints();
                //Calculate players ranks based on their points and write them back to player_points
                player_points = calcPlayerRanks();
                
                setCurrentPlayer(-1); //Set the current playernumber a non existing player

                //id=getPlayerIDByPnum(current_playernumber);
                //enlightenPlayer(id, current_playernumber); //Turn on players light
                //Start a new round as we're actually not within one
                switchmode(true);                

            }
            else {
                //Stop the current round
                switchmode(false);
                ThrowAllPlayerInEternalDarkness(); //Turn all players dark                
            }
        }
        else if (id=="btn_prevplayer"){
            //Go back to the previous Player... (just in case the dungeonmaster accidentially clicked next, as he skilled "gross motor skills" to maximum )
            pid=getPlayerIDByPnum(current_playernumber);
            //darkenPlayer(pid, current_playernumber, false);  //Darken the current player
            ThrowAllPlayerInEternalDarkness();
            if (current_playerindex > 0){
                //Fetch the new player by decrementing our index
                setCurrentPlayer(current_playerindex-1);   
            }
            else {
                //alert("Erster Spieler! : " + pid); //DEBUG
                setCurrentPlayer(player_points.length-1); //Rollover to the last player as we just got below the first player
            }
            pid=getPlayerIDByPnum(current_playernumber);
            enlightenPlayer(pid, current_playernumber); //Enlighten it 

            /*
            //Some-Button-Magic
            if (current_playerindex==0) { 
                //We're now at the first index and should disable the button                
                document.getElementById("btn_prevplayer").disabled=true;
                document.getElementById("btn_prevplayer").style.background="grey";
            }    
            
            if (current_playerindex < player_points.length-1) {
                document.getElementById("btn_nextplayer").disabled=false; //Enable the next-button
                document.getElementById("btn_nextplayer").style.background=button_org_background;
            }
            */

        }
        else if (id=="btn_noplayer"){
            // Disable all players. Can be used for example in case of an NPC-event
            ThrowAllPlayerInEternalDarkness(); //Turn all players dark          

        }
        else if (id=="btn_nextplayer"){
            document.getElementById("btn_prevplayer").hidden=false;
            document.getElementById("btn_nextplayer").innerHTML="Nächst. Spieler";
            //Iterate to the next Player...      
            pid=getPlayerIDByPnum(current_playernumber);
            //alert(current_playernumber + " => " + pid); //DEBUG
            //darkenPlayer(pid, current_playernumber, false);  //Darken the current player
            ThrowAllPlayerInEternalDarkness();
            if (current_playerindex < player_points.length-1) {
                //Fetch the new player by incrementing it
                setCurrentPlayer(current_playerindex+1);                
            }
            else {
                //alert("Letzter Spieler! : " + pid); //DEBUG
                //Fetch the new player
                setCurrentPlayer(0); //Rollover as we just exceeded the last player
            }
            pid=getPlayerIDByPnum(current_playernumber);
            enlightenPlayer(pid, current_playernumber); //Enlighten it

            /*
            if (current_playerindex > 0) {                
                document.getElementById("btn_prevplayer").disabled=false; //Enable the prev-button
                document.getElementById("btn_prevplayer").style.background=button_org_background;
            }

            if (current_playerindex >= player_points.length-1) {
                document.getElementById("btn_nextplayer").disabled=true; //Disable the next-button
                document.getElementById("btn_nextplayer").style.background="grey";
            }
            */

        }
    }

    function getPlayerIDByPnum(pnum)
    { //Get's a player's ID by loking up with pnum
        var myreturn = "not found!";
        try {
            for (let i=0; i<player_points.length; i++)
                { 
                    //alert(player_points[i].pnum + " => " + pnum); //DEBUG
                    if (player_points[i].pnum == pnum){
                        myreturn=player_points[i].id;
                        break;
                    }                    
                }
        }
        catch (e){
            alert(e);
        }
        finally{
            //alert(myreturn); //DEBUG
            return myreturn;
        }
    }

    function getAllPoints()
    { //Updates all player points by fething the values from the textboxes
        try {
            for (let i=0; i<player_uis.length; i++)
                { 
                    PlayerPointsChanged(player_uis[i].textbox_points);
                    //alert(i + " => " + player_uis[i].textbox_points); //DEBUG
                }
        }
        catch (e){
            alert(e);
        }
    }

    function PlayerNameChanged(id){        
        var p = document.getElementById(id.id);        
        // Get the Player of the current Text-Box
        var Player = getPlayerIDByNameTextBox(id.id);        
        savePlayername(Player, p.value);  // Save the value in backend
    }

    function PlayerPointsChanged(id){        
        var p = document.getElementById(id);        
        // Get the Player's points of the current Text-Box
        var Points = p.value;  //Get the points
        var Plid = getPlayerIDByPointsTextBox(id); //Get the corresponding player ID
        //alert(Plid + " => " + Points); //DEBUG        
        updatePlayerpoints(Plid, Points);
    }

    function getPlayerIDByNameTextBox(boxname)
    { // Will get the Player's ID by a given Name-Textbox        
        var myreturn = "Not found!";
        for (let i=0; i<player_uis.length; i++)
        {               
            if (boxname == player_uis[i].textbox_name)
            {  
                myreturn = player_uis[i].id;             
                break;
            }        
        }        
        // alert("! " + myreturn); //DEBUG
        return myreturn;
    }

    function getPlayerNameTextBoxByID(id)
    { // Will get the Player's Name-Textbox by a given ID
        var myreturn = "Not found!";
        for (let i=0; i<player_uis.length; i++)
        {               
            if (id == player_uis[i].id)
            {  
                myreturn = player_uis[i].textbox_name;             
                break;
            }        
        }        
        // alert("! " + myreturn); //DEBUG
        return myreturn;
    }

    function getPlayerIDByPointsTextBox(boxname)
    { // Will get the Player's ID by a given Points-Textbox        
        var myreturn = "Not found!";
        for (let i=0; i<player_uis.length; i++)
        {               
            if (boxname == player_uis[i].textbox_points)
            {  
                myreturn = player_uis[i].id;             
                break;
            }        
        }        
        // alert("! " + myreturn); //DEBUG
        return myreturn;
    }

    function getPlayerPointsTextBoxByID(id)
    { // Will get the Player's Point-Textbox by a given ID
        var myreturn = "Not found!";
        for (let i=0; i<player_uis.length; i++)
        {               
            if (id == player_uis[i].id)
            {  
                myreturn = player_uis[i].textbox_points;             
                break;
            }        
        }        
        // alert("! " + myreturn); //DEBUG
        return myreturn;
    }

    function makeGetRequest(encodedURI){
        //Will make a GET-Request to the backend. As fetch() is poorly supported, espacially on mobile browsers, we won't use it!
        //As we want a more flexible-solution we might use the jquery-library here
        //alert(encodedURI); //DEBUG
        $.get( encodedURI, function( data ) {
            $( ".result" ).html( data );
            alert( "Load was performed." );
        });    
    }

    function highlightPlayername(x) {
        x.style.background="red";
    }

    function getHostsIP(){
        // As Javascript will client-side the client might need to determine server's IP to make new requests
        // This method will return IP and Port which then can be used to craft a URL to make requests
        var ip = location.host;
        //alert(ip); // DEBUG
        return ip;
    }

    function savePlayername(id, name){
        //Will set the playername on backend-side
        var uri = encodeURI("http://"+getHostsIP()+"/engine?job=setplayer&id="+id+"&name="+name);  //Todo: Need to figure out why this does ten requests at once...
        makeGetRequest(uri);        
    }

    function enlightenPlayer(id, p_num){
        //Will tell the backend to turn on player's-light and also highlight the player in UI        
        var uri = encodeURI("http://"+getHostsIP()+"/engine?job=enlightplayer&id="+id+"&pnum="+p_num+"&onoff=light");  //Todo: Need to figure out why this does ten requests at once...
        //alert(uri); //DEBUG
        makeGetRequest(uri);

        
        //Highlight the player in UI
        //alert(id + " => Light"); //DEBUG
        namebox=document.getElementById(getPlayerNameTextBoxByID(id));
        pointsbox=document.getElementById(getPlayerPointsTextBoxByID(id));
        namebox.style.background="green";
        pointsbox.style.background="green";        
    }

    function darkenPlayer(id, p_num, ui_only){
        //Will tell the backend to turn on player's-light and also highlight the player in UI
        
        if (!ui_only) {
            //not only the ui should be turned off. Normal case, when just one player should be darkened        
            var uri = encodeURI("http://"+getHostsIP()+"/engine?job=enlightplayer&id="+id+"&pnum="+p_num+"&onoff=darkness");  //Todo: Need to figure out why this does ten requests at once...
            //alert(uri); //DEBUG
            makeGetRequest(uri);
        }

        //Darken the player in UI
        //alert(id + " => Darkness"); //DEBUG
        namebox= document.getElementById(getPlayerNameTextBoxByID(id));
        pointsbox= document.getElementById(getPlayerPointsTextBoxByID(id));                
        namebox.style.background=textbox_org_background;
        pointsbox.style.background=textbox_org_background;  
    }

    function ThrowAllPlayerInEternalDarkness(){
        //Will turn off all player lights and also disable the LED's for that player
        try {
            for (let i=0; i<player_uis.length; i++)  //iterate through all players
                { 
                    // alert(player_uis[i].id); //DEBUG
                    darkenPlayer(player_uis[i].id, player_points[i].pnum, true);  //Darken the current player                                      
                }
            
            // Make a GET-Request to darken all players at once
            var uri = encodeURI("http://"+getHostsIP()+"/engine?job=alldark");  //Todo: Need to figure out why this does ten requests at once...
            //alert(uri); //DEBUG
            makeGetRequest(uri);
        }
        catch (e){
            alert(e);
        }
    }

    // End: Functions

</script>
</body>
</html>
